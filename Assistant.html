<!DOCTYPE html>
<html>
<head>
<title>Kroniv - Voice Activated</title>
<style>
body {
  background: #050b14;
  color: #00eaff;
  font-family: monospace;
  text-align: center;
}
h1 {
  text-shadow: 0 0 15px cyan;
}
#console {
  margin-top: 20px;
  padding: 10px;
  border: 1px solid cyan;
  width: 80%;
  margin-left: auto;
  margin-right: auto;
  min-height: 50px;
}
#imageInput {
  display: none;
}
</style>
</head>
<body>

<h1>KRONIV â€” VOICE ACTIVATED</h1>
<div id="console">Say "Hey Kroniv" to start...</div>
<input type="file" id="imageInput" accept="image/*">

<script>
let maleVoice;
let isSpeaking = false;

// Load male voice
function loadMaleVoice() {
  let voices = window.speechSynthesis.getVoices();
  maleVoice = voices.find(v => v.name.toLowerCase().includes("male")) || voices[0];
}
window.speechSynthesis.onvoiceschanged = loadMaleVoice;

// Speak function
function speak(text) {
  if (!maleVoice) return;
  isSpeaking = true;
  document.getElementById("console").innerText = "Kroniv: " + text;

  let speech = new SpeechSynthesisUtterance(text);
  speech.voice = maleVoice;
  speech.rate = 1;
  speech.pitch = 1;

  speech.onend = () => {
    isSpeaking = false;
    recognition.start(); // resume listening after speaking
  };

  window.speechSynthesis.speak(speech);
}

// Gemini API
async function askGemini(question) {
  try {
    let response = await fetch(
      "https://apis-rho-nine.vercel.app/gemini?ask=" + encodeURIComponent(question)
    );
    let data = await response.json();
    return data.description || "No answer returned from Gemini API";
  } catch (err) {
    return "Error contacting Gemini API: " + err.message;
  }
}

// Gemini API with image
async function askGeminiWithImage(question, file) {
  let form = new FormData();
  form.append("ask", question);
  form.append("image", file);

  try {
    let response = await fetch("https://apis-rho-nine.vercel.app/gemini", {
      method: "POST",
      body: form
    });
    let data = await response.json();
    return data.description || "No answer from image query";
  } catch (err) {
    return "Error contacting Gemini API: " + err.message;
  }
}

// Image input handler
document.getElementById("imageInput").addEventListener("change", async (e) => {
  let file = e.target.files[0];
  if (!file) {
    speak("No image selected.");
    return;
  }
  speak("Analyzing image...");
  let answer = await askGeminiWithImage("Describe this image", file);
  speak(answer);
});

// Process commands with wake word
async function processCommand(cmd) {
  cmd = cmd.toLowerCase();

  // Check for wake word
  if (!cmd.startsWith("hey") && !cmd.startsWith("hey kroniv")) return;

  // Remove wake word
  cmd = cmd.replace(/^hey kroniv/, "").replace(/^hey/, "").trim();

  if (!cmd) {
    speak("Yes?");
    return;
  }

  // Built-in commands
  if (cmd.includes("hello")) speak("Greetings, creator. Kroniv is online.");
  else if (cmd.includes("who am i")) speak("You are divine consciousness in human form.");
  else if (cmd.includes("what is your name")) speak("I am Kroniv, your intelligent assistant.");
  else if (cmd.includes("open youtube")) { speak("Opening YouTube."); window.open("https://www.youtube.com"); }
  else if (cmd.includes("open google")) { speak("Opening Google."); window.open("https://www.google.com"); }
  else if (cmd.includes("open facebook")) { speak("Opening Facebook."); window.open("https://www.facebook.com"); }
  else if (cmd.includes("play music")) { speak("Opening Spotify."); window.open("https://open.spotify.com"); }
  else if (cmd.includes("what time is it")) { speak("The current time is " + new Date().toLocaleTimeString()); }
  else if (cmd.includes("what day is it")) { speak("Today is " + new Date().toDateString()); }
  else if (cmd.includes("battery")) {
    if (navigator.getBattery) navigator.getBattery().then(b => speak("Your battery level is " + Math.round(b.level*100) + " percent."));
    else speak("Battery info not supported.");
  }
  else if (cmd.includes("affirmation")) speak("I am powerful. I am divine. I move with clarity and purpose.");
  else if (cmd.includes("tell me a joke")) speak("Why did the robot cross the road? To compute the other side.");
  else if (cmd.includes("analyze image")) { speak("Please choose an image file."); document.getElementById("imageInput").click(); }
  else {
    speak("Let me think...");
    let answer = await askGemini(cmd);
    speak(answer);
  }
}

// Speech recognition setup
let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";
recognition.continuous = true;
recognition.interimResults = false;

recognition.onresult = function(event) {
  let command = event.results[event.results.length - 1][0].transcript;
  document.getElementById("console").innerText = "You: " + command;
  recognition.stop(); // stop while processing
  processCommand(command);
};

recognition.onend = function() {
  if (!isSpeaking) recognition.start(); // restart listening after speech ends
};

// Start assistant
window.onload = async () => {
  loadMaleVoice();
  speak("Kroniv online. Say 'Hey Kroniv' to start.");
  recognition.start();
};
</script>

</body>
</html>
